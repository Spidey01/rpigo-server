# vim: set filetype=sh :


rpigo_log_setup() {
    [ -d "$RPIGO_LOGDIR" ] || sudo -n mkdir -p "$RPIGO_LOGDIR"
    sudo -n chmod 0750 "$RPIGO_LOGDIR"
    sudo -n chown "${LOGNAME}:adm" "$RPIGO_LOGDIR"
}


rpigo_log_timestamp() {
    if [ -z "$RPIGO_DEVELOPER" ]; then
        date +"%Y-%m-%dT%H:%M%z" 
    else
        date +"T%H:%M" 
    fi
}


rpigo_log_message() {
    local level emsg n

    level="$1"
    shift

    emsg="${FUNCNAME[0]}(): Invalid log level: $level"

    n="${RPIGO_LOGLEVEL:-0}"

    case "$level" in
        x) [ $n -ge 5 ] || return 0 ;;
        d) [ $n -ge 4 ] || return 0 ;;
        i) [ $n -ge 3 ] || return 0 ;;
        w) [ $n -ge 2 ] || return 0 ;;
        e) [ $n -ge 1 ] || return 0 ;;
        wtf) ;; # always permit
        *)
            rpigo_error "$emsg"
            # also force an output.
            echo "$emsg" 1>&2
            return 64 # EX_USAGE
    esac

    echo "$(basename $0)/${level}(pid=$$, $(rpigo_log_timestamp)):" $* | tee -a "${RPIGO_LOGFILE:-/dev/null}" 1>&2
}


rpigo_trace() {
    rpigo_log_message x $*
}


rpigo_debug() {
    rpigo_log_message d $*
}


rpigo_info() {
    rpigo_log_message i $*
}


rpigo_warn() {
    rpigo_log_message w $*
}


rpigo_error() {
    rpigo_log_message e $*
}


rpigo_fatal() {
    local es opt

    es=1

    while getopts "e:" opt; do
        case $opt in
            e)
                es=$OPTARG
                ;;
            \?)
                echo "${FUNCNAME[0]}(): Invalid option: -$OPTARG" 1>&2
                return $OPTERR
                ;;
        esac
    done
    shift `expr $OPTIND - 1`

    rpigo_log_message wtf $*
    rpigo_warn "Aborting program with exit status $es."
    exit $es
}

